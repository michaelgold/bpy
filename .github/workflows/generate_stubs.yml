name: Generate Blender Python API Stubs

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Blender Version Tag (e.g., v4.0.1)'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.10.x'

      - name: Extract Major and Minor Versions
        run: python -c "import sys; version_tag = sys.argv[1].lstrip('v'); parts = version_tag.split('.'); major_version = '.'.join(parts[:2]); minor_version = '.'.join(parts[:3]); print(f'::set-output name=major_version::{major_version}'); print(f'MAJOR_VERSION={major_version}\nMINOR_VERSION={minor_version}')" ${{ github.event.inputs.tag }} >> $GITHUB_ENV" 
        id: version_extraction

      - name: Download Blender
        run: |
          wget "https://mirrors.ocf.berkeley.edu/blender/release/Blender${{ steps.version_extraction.outputs.major_version }}/blender-${{ steps.version_extraction.outputs.minor_version }}-linux-x64.tar.xz"
          tar -xf "blender-${{ steps.version_extraction.outputs.minor_version }}-linux-x64.tar.xz"
          mv "blender-${{ steps.version_extraction.outputs.minor_version }}-linux-x64" blender


      - name: Checkout Blender repository 
        uses: actions/checkout@v2
        with:
          repository: blender/blender
          ref: ${{ github.event.inputs.tag }} # Checkout the tag specified in the workflow dispatch
          submodules: 'recursive' # Recursively checkout submodules
          path: blender-git

      - name: Install Documentation Prerequisites
        run: |
          pip install bpystubgen

      - name: Generate API Docs and Stubs
        run: |
          cd blender
          ./blender --background --factory-startup -noaudio --python ../blender-git/doc/python_api/sphinx_doc_gen.py -- --output=../python_api
          python -m bpystubgen ../python_api/sphinx-in ../python_api/output

      - name: Upload Stubs as Artifact
        uses: actions/upload-artifact@v2
        with:
          name: blender-python-api-stubs-${{ steps.version_extraction.outputs.minor_version }}
          path: |
            python_api/output/**
